#!/bin/sh

DEVICE="$1"
HIGH_QUALITY=1

case "${DEVICE}" in
    mic-only)
        SOUND_INPUT=shared_input_usb_card_redirect_left_channel_to_right
        ;;
    system-only)
        SOUND_INPUT=shared_input_loopback
        ;;
    *)
        SOUND_INPUT=input_LOOPBACK_and_usb_card
        ;;
esac

if [ ${HIGH_QUALITY} = 1 ]; then
    CHANNELS=2
    SOUND_RATE=48000
    FRAMERATE=30
else
    CHANNELS=1
    SOUND_RATE=22050
    FRAMERATE=15
fi

ffmpeg \
  -thread_queue_size 512 \
  -video_size $(xdpyinfo | awk '/dimensions:/ { print $2; exit }') \
  -framerate "${FRAMERATE}" \
  -f x11grab \
  -i :0.0+0,0 \
  -thread_queue_size 512 \
  -f alsa \
  -ac "${CHANNELS}" \
  -i "${SOUND_INPUT}"  \
  -ar "${SOUND_RATE}" \
  ~/video/screen/"$(date --rfc-3339=seconds).mkv"
